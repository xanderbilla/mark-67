name: Full Stack Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  FRONTEND_IMAGE: ghcr.io/${{ github.repository }}/todo-frontend
  BACKEND_IMAGE: ghcr.io/${{ github.repository }}/todo-backend

jobs:
  get-infrastructure:
    uses: ./.github/workflows/get-infrastructure-info.yml
    secrets: inherit

  build-and-deploy:
    needs: get-infrastructure
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

      - name: Build Backend JAR
        working-directory: ./demo
        run: ./mvnw clean package -DskipTests

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Image Tags
        id: meta
        run: |
          echo "SHORT_SHA=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Build and Push Backend Image
        uses: docker/build-push-action@v6
        with:
          context: ./demo
          file: ./demo/Dockerfile
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:latest
            ${{ env.BACKEND_IMAGE }}:${{ steps.meta.outputs.SHORT_SHA }}

      - name: Build and Push Frontend Image
        uses: docker/build-push-action@v6
        with:
          context: ./ui
          file: ./ui/Dockerfile
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:latest
            ${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.SHORT_SHA }}
          build-args: |
            NEXT_PUBLIC_API_URL=http://${{ needs.get-infrastructure.outputs.backend-ip }}:8080/api

      - name: Deploy Backend to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.get-infrastructure.outputs.backend-ip }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Stop existing containers
            sudo docker stop todo-backend todo-mongodb 2>/dev/null || true
            sudo docker rm todo-backend todo-mongodb 2>/dev/null || true

            # Login to GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | sudo docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Run MongoDB
            sudo docker run -d \
              --name todo-mongodb \
              --restart unless-stopped \
              -p 27017:27017 \
              -e MONGO_INITDB_DATABASE=todoapp \
              -v mongodb_data:/data/db \
              mongo:7

            # Wait for MongoDB
            sleep 10

            # Run Backend
            sudo docker run -d \
              --name todo-backend \
              --restart unless-stopped \
              -p 8080:8080 \
              -e SPRING_DATA_MONGODB_URI=mongodb://todo-mongodb:27017/todoapp \
              -e SPRING_PROFILES_ACTIVE=production \
              --link todo-mongodb:todo-mongodb \
              ${{ env.BACKEND_IMAGE }}:${{ steps.meta.outputs.SHORT_SHA }}

            # Verify backend
            sleep 15
            curl -f http://localhost:8080/actuator/health

      - name: Deploy Frontend to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.get-infrastructure.outputs.frontend-ip }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Stop existing container
            sudo docker stop todo-frontend 2>/dev/null || true
            sudo docker rm todo-frontend 2>/dev/null || true

            # Login to GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | sudo docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Run Frontend
            sudo docker run -d \
              --name todo-frontend \
              --restart unless-stopped \
              -p 3000:3000 \
              -e NEXT_PUBLIC_API_URL=http://${{ needs.get-infrastructure.outputs.backend-ip }}:8080/api \
              ${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.SHORT_SHA }}

            # Verify frontend
            sleep 10
            curl -f http://localhost:3000

      - name: Deployment Summary
        run: |
          echo "ðŸŽ‰ Real Applications Deployed Successfully!"
          echo "=========================================="
          echo "Frontend: http://${{ needs.get-infrastructure.outputs.frontend-ip }}:3000"
          echo "Backend API: http://${{ needs.get-infrastructure.outputs.backend-ip }}:8080/api/todos"
          echo "Health Check: http://${{ needs.get-infrastructure.outputs.backend-ip }}:8080/actuator/health"
          echo "Nagios: http://100.26.150.36/nagios (nagiosadmin/nagiosadmin)"
